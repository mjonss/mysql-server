# The include statement below is a temp one for tests that are yet to
#be ported to run with InnoDB,
#but needs to be kept for tests that would need MyISAM in future.
--source include/force_myisam_default.inc

#Want to skip this test from daily Valgrind execution
--source include/no_valgrind_without_big.inc
# Turn on ssl between the client and server
# and run a number of tests

-- source include/have_ssl_communication.inc

# Save the initial number of concurrent sessions
--source include/count_sessions.inc

connect (ssl_con,localhost,root,,,,,SSL);

# Check ssl turned on
--replace_result ECDHE-RSA-AES128-GCM-SHA256 SSL_CIPHER DHE-RSA-AES128-GCM-SHA256 SSL_CIPHER DHE-RSA-AES256-SHA SSL_CIPHER
SHOW STATUS LIKE 'Ssl_cipher';

# Check ssl expiration
SHOW STATUS LIKE 'Ssl_server_not_before';
SHOW STATUS LIKE 'Ssl_server_not_after';

# Source select test case
-- source include/common-tests.inc

# Check ssl turned on
--replace_result ECDHE-RSA-AES128-GCM-SHA256 SSL_CIPHER DHE-RSA-AES128-GCM-SHA256 SSL_CIPHER DHE-RSA-AES256-SHA SSL_CIPHER
SHOW STATUS LIKE 'Ssl_cipher';

connection default;
disconnect ssl_con;

--echo #
--echo # Bug#54790: Use of non-blocking mode for sockets limits performance
--echo #

--echo # Open ssl_con and set a timeout.
connect (ssl_con,localhost,root,,,,,SSL);

LET $ID= `SELECT connection_id()`;
SET @@SESSION.wait_timeout = 2;

--echo # Wait for ssl_con to be disconnected.
connection default;
let $wait_condition=
  SELECT COUNT(*) = 0 FROM INFORMATION_SCHEMA.PROCESSLIST
  WHERE ID = $ID;
--source include/wait_condition.inc

--echo # Check that ssl_con has been disconnected.
connection ssl_con;
--echo # CR_SERVER_LOST, CR_SERVER_GONE_ERROR
--error 2006,2013
SELECT 1;

connection default;
disconnect ssl_con;

--echo #
--echo # Bug#89789: Option to disable SSL/TLS on running server
--echo #
connect (ssl_con,localhost,root,,,,,SSL);

# Check ssl turned on
--replace_result ECDHE-RSA-AES128-GCM-SHA256 SSL_CIPHER DHE-RSA-AES128-GCM-SHA256 SSL_CIPHER DHE-RSA-AES256-SHA SSL_CIPHER
SHOW STATUS LIKE 'Ssl_cipher';

SELECT @@global.ssl_announce;
SET @@global.ssl_announce = 0;
SELECT @@global.ssl_announce;

disconnect ssl_con;

--error 2026
connect (ssl_con,localhost,root,,,,,SSL);

--echo # ssl_con wihtout SSL
connect (ssl_con,localhost,root);

# Check ssl turned off
--replace_result ECDHE-RSA-AES128-GCM-SHA256 SSL_CIPHER DHE-RSA-AES128-GCM-SHA256 SSL_CIPHER DHE-RSA-AES256-SHA SSL_CIPHER
SHOW STATUS LIKE 'Ssl_cipher';

SELECT @@global.ssl_announce;
SELECT @@ssl_announce;
--error ER_INCORRECT_GLOBAL_LOCAL_VAR
SELECT @@session.ssl_announce;
--error ER_GLOBAL_VARIABLE
SET ssl_announce = 0;
SET @@global.ssl_announce = 0;
--error ER_GLOBAL_VARIABLE
SET @@session.ssl_announce = 0;
--error ER_WRONG_VALUE_FOR_VAR
SET @@global.ssl_announce = 'a';
SET @@global.ssl_announce = OFF;
SELECT @@global.ssl_announce;
SET @@global.ssl_announce = ON;
SELECT @@global.ssl_announce;
SET @@global.ssl_announce = 'OFF';
SELECT @@global.ssl_announce;
SET @@global.ssl_announce = 'ON';
SELECT @@global.ssl_announce;
--error ER_WRONG_VALUE_FOR_VAR
SET @@global.ssl_announce = -1;
--error ER_WRONG_VALUE_FOR_VAR
SET @@global.ssl_announce = 2;
SET @@global.ssl_announce = 1;
SELECT @@global.ssl_announce;

disconnect ssl_con;
--echo # ssl_con wiht SSL
connect (ssl_con,localhost,root,,,,,SSL);

# Check ssl turned on
--replace_result ECDHE-RSA-AES128-GCM-SHA256 SSL_CIPHER DHE-RSA-AES128-GCM-SHA256 SSL_CIPHER DHE-RSA-AES256-SHA SSL_CIPHER
SHOW STATUS LIKE 'Ssl_cipher';

SELECT @@global.ssl_announce;

disconnect ssl_con;
connection default;

# Wait till all disconnects are completed
--source include/wait_until_count_sessions.inc

##  This test file is for testing encrypted communication only, not other
##  encryption routines that the SSL library happens to provide!
